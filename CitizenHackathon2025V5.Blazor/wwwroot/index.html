<!-- wwwroot/index.html -->
<!DOCTYPE html>
<html lang="fr-BE">
<head>
    <meta charset="utf-8" />
    <title>CitizenHackathon 2025 - OutZen</title>

    <!-- Blazor: Load all globalization data -->
    <script>window.BlazorWebAssemblyLoadAllGlobalizationData = true;</script>

    <base href="/" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#000000" />
    <meta http-equiv="Cache-Control" content="no-cache" />
    <meta http-equiv="Pragma" content="no-cache" />

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet" />

    <!-- 1. Reset & basic variables    -->
    <link href="/CSS/base/reset.css" rel="stylesheet" />
    <link href="/CSS/base/variables.css?v=2" rel="stylesheet" />

    <!-- 2. Basic structure / layout / typography -->
    <link href="/CSS/base/base.css" rel="stylesheet" />
    <link href="/CSS/base/site.css" rel="stylesheet" />
    <link href="/CSS/base/app.css" rel="stylesheet" />
    <link href="/CSS/base/blazor-core.css" rel="stylesheet" />
    <link href="/CSS/base/layout.css" rel="stylesheet" />
    <link href="/CSS/base/SharedStyles.css" rel="stylesheet" />
    <link href="/CSS/base/simulator.css" rel="stylesheet" />

    <!-- 3. Themes (variables per theme, then OutZen) -->
    <link href="/CSS/themes/light.css" rel="stylesheet" />
    <link href="/CSS/themes/outzen.css" rel="stylesheet" />

    <!-- 4. Animations (keyframes + helpers) -->
    <link href="/CSS/animations/animations.css" rel="stylesheet" />
    <link href="/CSS/animations/pulseColors.css" rel="stylesheet" />
    <link href="/CSS/animations/visual-elements.css" rel="stylesheet" />

    <!-- 5. Generic components    -->
    <link href="/CSS/components/button.css?v=3" rel="stylesheet" />
    <link href="/CSS/components/detail-container.css" rel="stylesheet" />
    <link href="/CSS/components/info.css" rel="stylesheet" />
    <link href="/CSS/components/panels.css" rel="stylesheet" />
    <link href="/CSS/components/table.css" rel="stylesheet" />
    <link href="/CSS/components/suggestion.css" rel="stylesheet" />
    <link href="/CSS/components/globe.css" rel="stylesheet" />

    <!-- 6. Card components / OutZen (Leaflet, legends, markers) -->
    <link href="/CSS/components/map.css" rel="stylesheet" />

    <!-- 7. Specific pages -->
    <link href="/CSS/pages/crowd.css" rel="stylesheet" />
    <link href="/CSS/pages/Suggestion.css" rel="stylesheet" />
    <link href="/CSS/pages/traffic.css" rel="stylesheet" />
    <link href="/CSS/pages/weather.css" rel="stylesheet" />

    <!-- 8. External Styles -->
    <link href="/CSS/external/blazored-toast.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css"
          rel="stylesheet" />

    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">

    <style>
        .outzen-crowd-marker {
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
        }

            .outzen-crowd-marker > div {
                line-height: 1 !important;
            }
    </style>

    <!-- Leaflet -->
    <link rel="stylesheet" href="/lib/leaflet/leaflet.css" />

    <!-- MarkerCluster (paths aligned with your current tree) -->
    <link rel="stylesheet" href="/lib/leaflet.markercluster/MarkerCluster.css" />
    <link rel="stylesheet" href="/lib/leaflet.markercluster/MarkerCluster.Default.css" />

    <script src="/lib/leaflet/leaflet.js"></script>
    <script src="/lib/leaflet.markercluster/leaflet.markercluster.js"></script>

    <style>
        /* Minimal Leaflet fallback to ensure you see something even if leaflet.css doesn't load. */
        .leaflet-container {
            height: 100%;
            width: 100%;
            overflow: hidden;
            outline: 0;
            background: #1b1b1b;
        }

        .leaflet-pane,
        .leaflet-tile,
        .leaflet-marker-icon,
        .leaflet-marker-shadow,
        .leaflet-tile-container,
        .leaflet-pane > svg,
        .leaflet-pane > canvas,
        .leaflet-zoom-box,
        .leaflet-image-layer,
        .leaflet-layer {
            position: absolute;
            left: 0;
            top: 0;
        }

        .leaflet-control {
            position: relative;
            z-index: 800;
            pointer-events: auto;
        }

        .leaflet-marker-icon,
        .leaflet-marker-shadow,
        .leaflet-pane > canvas,
        .leaflet-pane > svg {
            pointer-events: none;
        }

        .leaflet-zoom-animated {
            transition: transform 0.25s;
        }

        .leaflet-marker-pane img,
        .leaflet-shadow-pane img {
            max-width: none !important;
        }
    </style>

    <!-- Diagnostic plugin cluster present/absent -->
    <script>
        window.addEventListener('load', () => {
            if (!window.L || (!L.MarkerClusterGroup && !L.markerClusterGroup)) {
                console.warn("[OutZen] ⚠️ Leaflet Cluster plugin not detected; clusters disabled.");
            } else {
                console.log("[OutZen] ✅ Leaflet Cluster plugin detected.");
            }
        });
    </script>

    <!-- Chart.js & Three.js (globals) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" crossorigin="anonymous"></script>

    <!-- SignalR global (only one version) -->
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.5/dist/browser/signalr.min.js"></script>

    <!-- Helper global pour Blazor: isOutZenBooted() -->
    <script>
        window.isOutZenBooted = function () {
            return !!window.__outzenBootFlag
                || !!(window.__OutZenSingleton && window.__OutZenSingleton.initialized);
        };
    </script>
</head>
<body>
    <script>
        (function hookLeafletMapDebug() {
            const isLocalhost =
                location.hostname === "localhost" ||
                location.hostname === "127.0.0.1" ||
                location.hostname === "[::1]";
            if (!isLocalhost) return;

            const qs = new URLSearchParams(location.search);
            const enabled = qs.get("hook") === "1";
            if (!enabled) return;

            if (window.__outzenLeafletHooked) return;
            window.__outzenLeafletHooked = true;

            const maxTries = 50;
            let tries = 0;

            function tryHook() {
                const L0 = window.L;
                if (!L0 || typeof L0.map !== "function") {
                    tries++;
                    if (tries < maxTries) return setTimeout(tryHook, 50);
                    console.warn("[HOOK] Leaflet still not ready after retries");
                    return;
                }

                if (L0.map.__outzenWrapped) {
                    console.warn("[HOOK] already wrapped");
                    return;
                }

                const original = L0.map;
                function wrappedMap(...args) {
                    const a0 = args?.[0];
                    const id = (typeof a0 === "string") ? a0 : (a0?.id ?? "(no-id)");
                    console.warn("[HOOK] L.map called. containerId =", id, "rawArg0=", a0);
                    console.trace("[HOOK] stack");
                    return original.apply(this, args);
                }
                wrappedMap.__outzenWrapped = true;
                wrappedMap.__outzenOriginal = original;
                L0.map = wrappedMap;

                console.warn("[HOOK] Leaflet L.map hooked (dev + ?hook=1)");
            }

            // hook after window load to stabilize ordering
            setTimeout(tryHook, 0);
        })();
    </script>

    <div id="app">
        <div class="loading-screen">
            <h1>OutZen</h1>
            <p>Loading...</p>
        </div>
        <div id="blazor-error-ui">
            An error has occurred.
            <a href="" class="reload">Reload</a>
            <a class="dismiss">×</a>
        </div>
    </div>

    <!-- Hidden Images -->
    <img src="/images/day.jpg?v=2" alt="Day Background" style="display:none;" />
    <img src="/images/night.jpg" alt="Night Background" style="display:none;" />
    <img id="bgImage" alt="Background" style="display:none;" />
    <img src="/images/earth_texture.jpg" alt="Earth Texture" style="display:none;" />

    <script>
        window.__OUTZEN_ESM_ONLY__ = true;
    </script>

    <!-- Overlay for mobile nav (created once, always available) -->
    <div id="ozNavOverlay" class="oz-nav-overlay" aria-hidden="true"></div>

    <!-- Your nav interop (optional if you already have it) -->
    <!--<script src="/js/navMenuInterop.js" defer></script>-->
    <script src="/js/outzen-nav.js"></script>
    <!-- Minimal global bridge -->
    <script src="/js/outzen-interop.js" defer></script>

    <!-- === Utility / Visual Modules === -->
    <script type="module" src="/js/app/timeEffects.js"></script>
    <script type="module" src="/js/app/wasmUtils.js"></script>
    <script type="module" src="/js/app/earthRotation.js"></script>
    <script type="module" src="/js/app/ui.effects.js"></script>

    <!-- Minimal interop bridge -->
    <script src="/js/trafficInterop.js" defer></script>
    <script src="/js/vendor/interop.js" defer></script>
    <script src="/js/crowdbar.js" defer></script>

    <!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator && location.hostname !== "localhost") {
            navigator.serviceWorker.register('/service-worker.published.js')
                .then(reg => console.log("✅ Service Worker registered:", reg.scope))
                .catch(err => console.error("❌ SW registration failed:", err));
        } else {
            console.log("⚠️ Service Worker disabled in development.");
        }
    </script>

    <!-- Background (Day/Night switch) -->
    <script>
        (function () {
            const hour = new Date().getHours();
            // Consistent night window for everything (globe + background)
            const isNight = (hour >= 20 || hour < 7);

            // 1) Global flag for the entire OutZen ecosystem
            window.OutZenIsNight = isNight;

            // 2) Class on <body> for your CSS theme
            document.addEventListener('DOMContentLoaded', function () {
                const body = document.body;
                if (!body) return;
                body.classList.toggle('night-mode', isNight);
                body.classList.toggle('day-mode', !isNight);
            });

            // 3) Preload globe texture (day or night)
            const texLink = document.createElement('link');
            texLink.rel = 'preload';
            texLink.as = 'image';
            texLink.crossOrigin = 'anonymous';
            texLink.href = isNight ? '/images/earth_texture_night.jpg' : '/images/earth_texture.jpg';
            document.head.appendChild(texLink);


            // 4) Background image (day.jpg / night.jpg) via #bgImage
            const bg = document.getElementById('bgImage');
            if (bg) {
                bg.src = isNight ? '/images/night.jpg' : '/images/day.jpg?v=2';
                bg.style.display = 'block';
            }
        })();
    </script>

    <!-- Small helpers for Blazor -->
    <script>
        window.scrollInterop = window.scrollInterop || {};
        window.scrollInterop.getScrollTop = (el) => Math.trunc((el?.scrollTop ?? window.scrollY ?? 0) || 0);
        window.scrollInterop.getScrollHeight = (el) => Math.trunc(el?.scrollHeight ?? document.scrollingElement?.scrollHeight ?? 0);
        window.scrollInterop.getClientHeight = (el) => Math.trunc(el?.clientHeight ?? document.documentElement?.clientHeight ?? 0);

        // possible compat
        window.getScrollTop = window.scrollInterop.getScrollTop;
        window.getScrollHeight = window.scrollInterop.getScrollHeight;
        window.getClientHeight = window.scrollInterop.getClientHeight;
    </script>


    <!-- === OutZen Core Modules (stable import, no cache-bust) === -->
    <script>
        window.OUTZEN_AUTOBOOT = window.OUTZEN_AUTOBOOT === true; // default off
        window.__importLoopDisabled = window.__importLoopDisabled ?? false;
    </script>

    <!--
    <script type="module">
        (async () => {
            if (window.__importLoopDisabled) { console.info("[OutZen] import loop disabled (index.html)"); return; }
            try {
                const m = await import('/js/app/leafletOutZen.module.js');
                console.log('OutZen Exports:', Object.keys(m));
                if (window.OUTZEN_AUTOBOOT === true && typeof m.bootOutZen === 'function') {
                    await m.bootOutZen({ mapId: 'leafletMap', enableChart: false });
                    console.log('✅ OutZen auto-booted (index.html)');
                }
            } catch (e) {
                console.error('[OutZen] import failed (index):', e);
            }
        })();
    </script>
    -->
    <!-- === Blazor Boot === -->
    <script src="_framework/blazor.webassembly.js"></script>
</body>
</html>









































































<!--/*// Copyrigtht (c) 2025 Citizen Hackathon https://github.com/POLLESSI/Citizenhackathon2025V5.Blazor.Client. All rights reserved.*/-->