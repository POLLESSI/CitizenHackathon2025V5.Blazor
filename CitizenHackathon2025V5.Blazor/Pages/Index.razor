@page "/"
@using CitizenHackathon2025.Blazor.DTOs
@using CitizenHackathon2025V5.Blazor.Client.Pages.FloatingWindows
@using CitizenHackathon2025V5.Blazor.Client.Shared
@using CitizenHackathon2025V5.Blazor.Client.Services
@using Microsoft.JSInterop
@inherits CitizenHackathon2025V5.Blazor.Client.Pages.Shared.OutZenMapPageBase
@inject Blazored.Toast.Services.IToastService ToastService

<PageTitle>OutZen - Home</PageTitle>

<div class="home-page">
    @* <div id="@MapId" style="height: 72vh;"></div> *@
    <!-- Summary map -->
    <div class="oz-page oz-page--home">
        <div class="homeMapCard">
            <div id="@MapId" class="oz-map"></div>
           @*  <div id="leafletMap-home" class="leaflet-host"></div> *@
            <!-- Optional: canvas for the weather chart if you want to put it back -->
            @* <canvas id="crowdChart"></canvas> *@
        </div>
    </div>
    <OzFloatingWindow Id="msgDrawer"
                      Class="oz-glass oz-drawer--fill"
                      Title="Messages"
                      Subtitle="Live"
                      FabIcon="Comments"
                      FabTitle="Open Messages"
                      FabRight="18px"
                      FabBottom="84px"
                      StartLeft="24px"
                      StartTop="420px"
                      Width="360px"
                      MinWidth="280px"
                      MaxWidth="900px">
        <MessageFloatingContent />
    </OzFloatingWindow>
    <OzFloatingWindow Id="gptDrawer"
                      Class="oz-glass oz-drawer--fill"
                      Title="OutZen GPT"
                      Subtitle="Suggestions"
                      FabIcon="IA Suggestions"
                      FabTitle="Open GPT"
                      FabRight="18px"
                      FabBottom="18px"
                      StartLeft="24px"
                      StartTop="120px"
                      Width="360px"
                      MinWidth="280px"
                      MaxWidth="900px">

        <input class="oz-input" placeholder="To research..." @bind="_q" @bind:event="oninput" />

        <div class="oz-prompt-compose">
            <textarea class="oz-input" rows="3" placeholder="Write your prompt..." @bind="_userPrompt"></textarea>
            <div class="oz-compose-actions">
                <button type="button" class="oz-btn" @onclick="SendUserPromptAsync" disabled="@string.IsNullOrWhiteSpace(_userPrompt)">
                    Send to AI
                </button>
            </div>
        </div>

        <div class="oz-scrollfill">
            <div class="oz-list">
                @foreach (var x in FilterGpt(_visible))
                {
                    <div class="oz-item">
                        <div class="oz-item-title">@x.Prompt</div>
                        <div class="oz-item-meta">@x.CreatedAt.ToLocalTime()</div>
                        <div class="oz-actions">
                            <button type="button" class="oz-mini" @onclick="@(() => Replay(x.Id))">Replay</button>
                            <button type="button" class="oz-mini" @onclick="@(() => Copy(x.Prompt))">Copy</button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </OzFloatingWindow>


    <!-- Top banner: title + globe -->
    <div class="home-header">
        <div class="home-header-left">
            <h1 class="index-title">Welcome to OutZen application</h1>
            <p class="index-subtitle">
                Explore events with peace of mind, even when the crowds get involved.
            </p>
        </div>
    </div>
    <!-- Main block: map + side panel -->
    <div>
        <button class="index-cta" @onclick="ScrollToSuggestions">
            Discover the suggestions
        </button>
    </div>
    <div class="home-main">
        <!-- Side panel: GPT + message -->
        <aside class="home-side-panel scroll-fade">
            <section class="home-block">
                <h2>AI Suggestions (GPT)</h2>
                <p class="home-block-subtitle">
                    Last generated suggestions and insights.
                </p>
                <div class="gpt-table-wrapper">
                    <table class="oz-table compact">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Title / Prompt</th>
                                <th>Summary</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (GptInteractions is { Count: > 0 })
                            {
                                @foreach (var g in GptInteractions)
                                {
                                    <tr>
                                        <td>@(g.SourceType ?? "GPT")</td>
                                        <td>@(g.Prompt ?? $"#{g.Id}")</td>
                                        <td>@Shorten(g.Response, 120)</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="3" class="text-muted">No AI interactions yet.</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </section>
            <section class="home-block">
                <h2>Your message</h2>
                <EditForm Model="@Model" OnValidSubmit="SendMessageAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    <input class="input"
                           placeholder="Message…"
                           @bind="NewMessage"
                           @bind:event="oninput" />

                    <button class="btn"
                            disabled="@IsSending"
                            @onclick="SendMessageAsync">
                        Send
                    </button>
                </EditForm>
            </section>
        </aside>
    </div>
    <!-- Suggestions (for the scroll button) -->
    <div>
        <section class="index-section scroll-fade" id="suggestions">
            <h2>Suggestions Zen</h2>
            <p>
                Here are some alternatives within a 25 km radius of the selected event:
            </p>

            <ul>
                <li>Upper Sambre Natural Park</li>
                <li>Outdoor yoga classes in Gosselies</li>
                <li>Open-air theater – La Traviata</li>
            </ul>
        </section>
    </div>
    <div class="earth-container scroll-fade">
        <Globe CanvasId="homeEarth"
               Width="320"
               Height="320"
               ShowControls="true"
               CssClass="globe-in-header" />
    </div>
    <div>
        <button class="btn" @onclick="EnableSoundAsync">Enable sound</button>
    </div>

    <footer class="index-footer">
        &copy; 2025 OutZen – Zen in the crowd, Zen in life.
    </footer>
</div>











































































@* // Copyrigtht (c) 2025 Citizen Hackathon https://github.com/POLLESSI/Citizenhackathon2025V5.Blazor.Client. All rights reserved. *@




