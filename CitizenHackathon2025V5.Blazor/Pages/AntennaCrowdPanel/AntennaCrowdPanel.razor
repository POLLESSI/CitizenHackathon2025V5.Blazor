@page "/antennacrowdpanel"
@using CitizenHackathon2025.Blazor.DTOs
@using CitizenHackathon2025.Blazor.DTOs.Security
@inherits CitizenHackathon2025V5.Blazor.Client.Pages.Shared.OutZenMapPageBase

<h1>Antenna Crowd Panel</h1>

<div class="antennaCrowd-page">
    <div class="map-host" id="leafletMap" style="height:480px; min-height:480px;"></div>

    <div class="antenna-list"
         @ref="ScrollContainerRef"
         @onscroll="HandleScrollAsync"
         style="max-height:420px; overflow:auto;">

        @foreach (var a in _visibleAntennas)
        {
            <div class="oz-row">
                <div class="oz-kv">
                    <div class="oz-k">#{@a.Id}</div>
                    <div class="oz-v">@a.Name</div>
                </div>
            </div>
        }
    </div>

    <div class="oz-card">
        <div class="oz-card-header">
            <div class="oz-title">Nearest antenna</div>
            <div class="oz-subtitle">Window: @WindowMinutes min — Radius: @MaxRadiusMeters m</div>
        </div>

        @if (SelectedEventId is null)
        {
            <div class="oz-muted">Select an event to display the nearest antenna and the crowd size.</div>
        }
        else if (_loading)
        {
            <div class="oz-muted">Loading…</div>
        }
        else if (_eventCrowd is null)
        {
            <div class="oz-warn">No antennas found within range (@MaxRadiusMeters m).</div>
        }
        else
        {
            <div class="oz-row">
                <div class="oz-kv">
                    <div class="oz-k">AntenneId</div>
                    <div class="oz-v">@_eventCrowd.AntennaId</div>
                </div>
                <div class="oz-kv">
                    <div class="oz-k">Distance</div>
                    <div class="oz-v">@($"{_eventCrowd.DistanceMeters:0} m")</div>
                </div>
            </div>

            <div class="oz-row">
                <div class="oz-metric">
                    <div class="oz-metric-label">Connexions actives</div>
                    <div class="oz-metric-value">@_eventCrowd.Counts.ActiveConnections</div>
                </div>
                <div class="oz-metric">
                    <div class="oz-metric-label">Devices uniques</div>
                    <div class="oz-metric-value">@_eventCrowd.Counts.UniqueDevices</div>
                </div>
            </div>

            <div class="oz-muted">
                UTC window : @_eventCrowd.Counts.WindowStartUtc.ToString("u") → @_eventCrowd.Counts.WindowEndUtc.ToString("u")
            </div>
        }
    </div>
</div>
















































































                @* // Copyrigtht (c) 2025 Citizen Hackathon https://github.com/POLLESSI/Citizenhackathon2025.API. All rights reserved. *@