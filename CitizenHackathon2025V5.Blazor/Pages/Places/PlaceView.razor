@page "/placeview"
@using CitizenHackathon2025V5.Blazor.Client.Constants
@using CitizenHackathon2025V5.Blazor.Client.Pages.Places
@using CitizenHackathon2025.Blazor.DTOs;
@implements IAsyncDisposable

<span class="fas fa-certificate me-2"></span> Places

<!-- === MAP PANEL === -->
<div class="map-host" id="placeMap" style="height:480px;min-height:480px; width:100%;"></div>

<div class="page-list">
    @* <h3>Place List</h3> *@
    <div class="list-toolbar">
        <div class="left">
            <input class="input-compact" placeholder="Search..."
                   @bind="_q" @bind:event="oninput" />
            @if (!string.IsNullOrWhiteSpace(_q))
            {
                <span class="badge badge-info">“@_q”</span>
            }
        </div>

        <div class="right">
            <button class="chip @( _onlyRecent ? "active" : null )"
                    @onclick="ToggleRecent">
                Recent
            </button>
        </div>
        <div>
            <NavLink class="chip add-chip" href="/placecreate">
                Add
            </NavLink>
        </div>
    </div>
    <div id="leafletMap" class="map"></div>
    <div class="table-wrapper draggable-container"
         @ref="ScrollContainerRef"
         @onscroll="HandleScroll"
         style="height: 300px; overflow-y: auto; border: 1px solid #444;">
        <table class="table table-striped table-dark styled-table data-list">
            <thead>
                <tr>
                    <th class="col-narrow">Name</th>
                    <th class="col-narrow">Indoor</th>
                    <th class="col-narrow">Type</th>
                    <th class="col-actions"></th>
                </tr>
            </thead>
            <tbody>
                @if (!FilterPlace(visiblePlaces).Any())
                {
                    <tr>
                        <td colspan="99">
                            <div class="empty-state">No places available at the moment.</div>
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var pl in FilterPlace(visiblePlaces))
                    {
                        <tr>
                            <td class="text-ellipsis" title="@pl.Name">@pl.Name</td>
                            <td class="text-ellipsis" title="@pl.Indoor">@((pl.Indoor) ? "Yes" : "No")</td>
                            <td class="text-ellipsis" title="@pl.Type">@pl.Type</td>
                            <td class="col-actions">
                                <!-- ✅ in-page detail panel -->
                                <button class="btn btn-sm btn-glow ev-chip" @onclick="() => Select(pl.Id)">Info</button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<Globe />

@if (SelectedId > 0)
{
    <div class="detail-wrapper">
        <div class="list-toolbar">
            <div class="left"><span class="badge badge-info">Details #@SelectedId</span></div>
            <div class="right">
                <button class="chip" @onclick="CloseDetail">Close</button>
            </div>
        </div>

        <!-- ✅ renders the detail panel in the same page -->
        <PlaceDetail Id="SelectedId" />
    </div>
}

@if (!FilterPlace(visiblePlaces).Any())
{
    <div class="oz-empty">No items for these filters.</div>
}
