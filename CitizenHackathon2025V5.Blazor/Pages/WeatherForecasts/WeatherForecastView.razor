@page "/weatherforecastview"
@using CitizenHackathon2025V5.Blazor.Client.Models
@using CitizenHackathon2025.Blazor.DTOs
@using CitizenHackathon2025V5.Blazor.Client.Constants
@using CitizenHackathon2025.Contracts.DTOs;
@implements IAsyncDisposable

@inject IJSRuntime js
@inject WeatherHubClient WeatherHub

<span class="fas fa-certificate me-2"></span> WeatherForecasts

<WeatherAlertBanner Alert="_currentRainAlert" OnDismiss="OnAlertDismissed" />

<div class="page-list">
    <div class="list-toolbar">
        <div class="left">
            <input class="input-compact" placeholder="Search weather..."
                   @bind="_q" @bind:event="oninput" />
            @if (!string.IsNullOrWhiteSpace(_q))
            {
                <span class="badge badge-info">“@_q”</span>
            }
        </div>

        <div class="right">
            <button class="chip @( _onlyRecent ? "active" : null )"@onclick="() => ToggleRecent()">Recent</button>
        </div>
        <div>
            <NavLink class="chip add-chip" href="/weatherforecastcreate">
                Add
            </NavLink>
        </div>
    </div>
    <div class="map-shell">
        <div id="leafletMap-weatherforecastview"></div>
    </div>
    <div class="chart-toolbar">
        <button class="chip @(_selectedMetric == WeatherMetric.Temperature ? "active" : null)"
                @onclick="() => ChangeMetric(WeatherMetric.Temperature)">
            Temp °C
        </button>
        <button class="chip @(_selectedMetric == WeatherMetric.Humidity ? "active" : null)"
                @onclick="() => ChangeMetric(WeatherMetric.Humidity)">
            Humidité %
        </button>
        <button class="chip @(_selectedMetric == WeatherMetric.Wind ? "active" : null)"
                @onclick="() => ChangeMetric(WeatherMetric.Wind)">
            Vent km/h
        </button>
    </div>


    <div class="chart-wrapper" style="height: 180px; margin-top: 8px;">
        <canvas id="crowdChart"></canvas>
    </div>

    <div class="table-wrapper draggable-container"
            @ref="ScrollContainerRef"
            @onscroll="HandleScroll"
            style="height: 300px; overflow-y: auto; border: 1px solid #444;">
        <table class="table table-striped table-dark styled-table data-list">
            <thead>
                <tr>
                    <th>#</th>
                    <th class="col-narrow">TemperatureC</th>
                    <th class="col-narrow">TemperatureC</th>
                    <th class="col-narrow">Summary</th>
                    <th class="col-actions"></th>
                </tr>
            </thead>
            <tbody>
                @if (!FilterWeather(visibleWeatherForecasts).Any())
                {
                    <tr><td colspan="99"><div class="empty-state">No weather forecast available at the moment.</div></td></tr>
                }
                else
                {
                @foreach (var we in FilterWeather(visibleWeatherForecasts))
                    {
                        <tr>
                            <td>•</td>
                            <td>@we.TemperatureC</td>
                            <td>@we.TemperatureC</td>
                            <td>@we.Summary</td>
                            <td>
                            <button class="btn btn-sm wx-chip @GetWeatherCss(@we.IsSevere) btn-glow"
                                title="See details"
                                @onclick="() => ClickInfo(we.Id)">
                                    Weather 
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<button class="btn btn-primary" @onclick="GenerateOne">Generate a forecast</button>

<Globe />
          
@if (SelectedId > 0)
{
    <div class="detail-wrapper">
        <div class="list-toolbar">
            <div class="left"><span class="badge badge-info">Details #@SelectedId</span></div>
            <div class="right">
                <button class="chip" @onclick="() => SelectedId = 0">Closed</button>
            </div>
        </div>
        <WeatherForecastDetail Id="@SelectedId" />
    </div>
}
@if (!FilterWeather(visibleWeatherForecasts).Any())
{
    <div class="oz-empty">No items for these filters.</div>
}
@if (_currentRainAlert is not null)
{
    <RainAlertToast Alert="_currentRainAlert" OnDismiss="OnAlertDismissed" />
}






















































































@* // Copyrigtht (c) 2025 Citizen Hackathon https://github.com/POLLESSI/Citizenhackathon2025V5.Blazor.Client. All rights reserved. *@




