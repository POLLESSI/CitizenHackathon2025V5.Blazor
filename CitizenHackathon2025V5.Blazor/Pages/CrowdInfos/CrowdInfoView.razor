@page "/crowdinfoview"
@using CitizenHackathon2025.Blazor.DTOs;
@using CitizenHackathon2025V5.Blazor.Client.Utils
@using CitizenHackathon2025V5.Blazor.Client.Enums
@inject IJSRuntime js
@implements IAsyncDisposable

<span class="fas fa-certificate me-2"></span> Crowd Infos

<div class="crowd-page">
    <div class="map-host" id="leafletMap" style="height:480px; min-height:480px;"></div>

    <div class="chart-panel">
        <canvas id="crowdChart"></canvas>
    </div>

    @* <div class="list-panel" @ref="ScrollContainerRef" @onscroll="HandleScroll">
        @foreach (var co in visibleCrowdInfos)
        {
            <div class="info-row @GetLevelCss(co.CrowdLevel)" @onclick="@(() => ClickInfo(co.Id))">
                <div class="title">@co.LocationName</div>
                <div class="meta">(@co.Latitude, @co.Longitude) — @co.Timestamp.ToLocalTime().ToString("HH:mm:ss")</div>
                <div class="desc">@InfoDesc(co)</div>
            </div>
        }
    </div> *@
</div>


<div class="page-list">
    <div class="list-toolbar">
        <div class="left">
            <input class="input-compact" placeholder="Search..." @bind="Q" @bind:event="oninput" />
            @if (!string.IsNullOrWhiteSpace(_q))
            {
                <span class="badge badge-info">“@_q”</span>
            }
        </div>

        <div class="right">
            <button class="chip @( _onlyRecent ? "active" : null )"
                    @onclick="() => ToggleRecent()">
                Recent
            </button>
        </div>

        <div>
            <NavLink class="chip add-chip" href="/crowdinfocreate">
                Add
            </NavLink>
        </div>
    </div>

    <div class="table-wrapper draggable-container"
         @ref="ScrollContainerRef"
         @onscroll="HandleScroll"
         style="height:300px; overflow-y:auto; border:1px solid #444;">
        <table class="table table-striped table-dark styled-table data-list">
            <thead>
                <tr>
                    <th>Location Name</th>
                    <th>Level</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @if (!FilterCrowd(visibleCrowdInfos).Any())
                {
                    <tr><td colspan="3"><div class="empty-state">No Crowd Informations Available.</div></td></tr>
                }
                else
                {
                    @foreach (var co in FilterCrowd(visibleCrowdInfos))
                    {
                        <tr>
                            <td>@co.LocationName</td>
                            <td>
                                <span class="crowd @($"crowd--{co.CrowdLevel}")">@co.CrowdLevel</span>
                            </td>
                            <td>
                                <button class="btn btn-sm info-chip @GetLevelCss(co.CrowdLevel)"
                                        title="@InfoDesc(co)"
                                        @onclick="() => ClickInfo(co.Id)">
                                    Info
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
    <div>
        <button @onclick="TestMarkers">Test Markers</button>
    </div>
    <div>
        <button @onclick="TestBoot">Test Boot</button>
    </div>
</div>

<Globe />

@if (SelectedId > 0)
{
    <div class="detail-wrapper">
        <div class="list-toolbar">
            <div class="left"><span class="badge badge-info">Détail #@SelectedId</span></div>
            <div class="right">
                <button class="chip" @onclick="() => SelectedId = 0">Fermer</button>
            </div>
        </div>
        <CrowdInfoDetail Id="@SelectedId" />
    </div>
}

@code {
    async Task TestMarkers()
    {
        if (_outzen is null) return;

        var testData = new[]
        {
        new { Id=1, Lat=50.89, Lng=4.34, Level=2, Name="Parck" },
        new { Id=2, Lat=50.88, Lng=4.35, Level=3, Name="Station" },
        new { Id=3, Lat=50.90, Lng=4.33, Level=4, Name="Center" }
    };

        foreach (var t in testData)
        {
            await _outzen.InvokeVoidAsync("addOrUpdateCrowdMarker",
                t.Id, t.Lat, t.Lng, t.Level,
                new { title = t.Name, description = "Test" });
        }

        try { await _outzen.InvokeVoidAsync("fitToMarkers"); } catch { }
    }

    async Task TestBoot()
    {
        if (_outzen is null) return;

        await _outzen.InvokeVoidAsync("clearCrowdMarkers");
        await _outzen.InvokeVoidAsync("addOrUpdateCrowdMarker", "999", 50.89, 4.34, 5,
            new { title = "TEST", description = "debug" });
        try { await _outzen.InvokeVoidAsync("fitToMarkers"); } catch { }
    }

}
















































































@* // Copyrigtht (c) 2025 Citizen Hackathon https://github.com/POLLESSI/Citizenhackathon2025V5.Blazor.Client. All rights reserved. *@